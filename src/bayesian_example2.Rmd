---
<<<<<<< HEAD
title: "Bayesian probability in placenta previa"
=======
title: "Bayesian 2 probability in placenta previa"
>>>>>>> 6aec6a2f5ba6be1f95b272c6787227c9cd656bce
output:
  md_document:
    variant: gfm
    preserve_yaml: true
layout: default
nav_order: 5
math: mathjax
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path='../assets/images/')  # Make sure this path is correct
```

<<<<<<< HEAD
# Bayesian - Probability of a girl birth given placenta previa
=======
# Bayesian: Part 2 Probability of a girl birth given placenta previa
>>>>>>> 6aec6a2f5ba6be1f95b272c6787227c9cd656bce

Last update:
```{r, date, echo = FALSE}
print(Sys.Date())
```

<<<<<<< HEAD
This doc was built with: `rmarkdown::render("Bayesian_example1.Rmd", output_file = "../pages/bayesian_example1.md")`

## Introduction

This example is described in the textbook:
Bayesian Data Analysis, by Andrew Gelman, John Carlin, Hal Stern, David Dunson, Aki Vehtari, and Donald Rubin. Third edition, (BDA3),
<http://www.stat.columbia.edu/~gelman/book/>.
The code is based on a version by Aki Vehtari. 

In an interesting Bayesian case study, we examine the probability of a girl birth among births with the condition placenta previa, where the placenta obstructs a normal vaginal delivery. An early study in Germany found that out of 980 births with placenta previa, 437 were female. We aim to assess the evidence supporting the hypothesis that the proportion of female births in this condition is less than the general population proportion of 0.485.

![](../assets/images/Bayes_Placenta_Previa.jpg)
<https://commons.wikimedia.org/wiki/Category:Placenta_previa#/media/File:2906_Placenta_Previa-02.jpg> CC BY 3.0.

## Bayesian Framework

### Data and Model

We define the observed study data: 
=======
This doc was built with: `rmarkdown::render("Bayesian_example2.Rmd", output_file = "../pages/bayesian_example2.md")`

## Introduction to part 2

The code is based on a version by Aki Vehtari. 

In the continuation of the analysis on placenta previa, we look at different priors to understand their impact on the posterior distribution. This part not only revisits the basic steps introduced in Part 1 but also expands on them by exploring alternative prior settings to illustrate the sensitivity of our posterior estimates to the choice of prior.

Following the initial setup where we determined the posterior distribution using a uniform prior, Part 2 investigates how different priors influence the results. This is crucial for assessing the robustness of our conclusions against the assumptions we make in our Bayesian framework.

```{r Bayes_ex2_setup, include=FALSE}

# Ensure consistent library usage
library(ggplot2)
theme_set(theme_bw())
library(dplyr)
library(tidyr)
```
>>>>>>> 6aec6a2f5ba6be1f95b272c6787227c9cd656bce

* $$X = 437$$ - number of female births in placenta previa
* $$Y = 543$$ - number of male births in placenta previa
* $$n = 980$$ - total births in placenta previa
<<<<<<< HEAD
* $$0.485$$ - frequency of normal female births in the population
* Posterior is Beta(438,544)

The parameter of interest, $$\theta$$, represents the probability of a female birth in placenta previa cases.
We calculate and plot the posterior distribution of the proportion of $$\theta$$, using uniform prior on $$\theta$$.


In Bayesian analysis, especially when dealing with proportions like the probability of a girl birth in this scenario, understanding the entire distribution is crucial. The Beta distribution, being the conjugate prior for binomial likelihoods, is particularly sensitive to the shape parameters ($$\alpha$$ and $$\beta$$), which in this case are derived from the observed data (437 girls, 543 boys) plus one for each due to the uniform prior assumption ($$\alpha = X + 1$$, $$\beta = n - X + 1$$):

- **Alpha (438)**: Represents the number of successes (female births) plus one.
- **Beta (544)**: Represents the number of failures (male births) plus one.


```{r Bayes_ex1_dataset, include=TRUE}
library(ggplot2)
theme_set(theme_bw())
# Posterior is Beta(438,544)

# seq creates evenly spaced values
df1 <- data.frame(theta = seq(0.375, 0.525, 0.001)) 
a <- 438
b <- 544 

```

```{r Bayes_ex1_dataext, include=FALSE}

pop_freq <- 0.485
lab_pop <- paste0("Population\nfrequency of\nfemale births:\n", pop_freq)
```
### Prior and Posterior Distributions

Under a **uniform prior distribution** (implying no prior bias towards specific values), the beta distribution is utilised as the conjugate prior. The posterior distribution then is:

$$ \text{Posterior}(\theta) = \text{Beta}(\alpha + X, \beta + n - X) = \text{Beta}(438, 544) $$

This choice of prior reflects an initial belief that all values of $$\theta$$ are equally likely, from 0 to 1.

```{r Bayes_ex1_beta, include=TRUE}
# dbeta computes the posterior density
df1$p <- dbeta(df1$theta, a, b)
```

```{r Bayes_ex1_ci, include=TRUE}
# compute also 95% central interval
# seq creates evenly spaced values from 2.5% quantile
# to 97.5% quantile (i.e., 95% central interval)
# qbeta computes the value for a given quantile given parameters a and b
df2 <- data.frame(theta = seq(qbeta(0.025, a, b), qbeta(0.975, a, b), length.out = 100))
```

```{r Bayes_ex1_post, include=TRUE}
# compute the posterior density
df2$p <- dbeta(df2$theta, a, b)
```


```{r, stats, include=TRUE}
data_mean <- round(mean(df2$theta), digits = 3)
data_sd <- round(sd(df2$theta), digits = 3)
data_lab <- paste0("Frequency of\nfemale births\nin placenta previa\nmean = ", data_mean, "\nsd = ", data_sd)
```

```{r Bayes_ex1_plot, include=TRUE}
# Plot posterior (Beta(438,544)) and 48.8% line for population average
ggplot(mapping = aes(theta, p)) +
  geom_line(data = df1) +
  # Add a layer of colorized 95% posterior interval
  geom_area(data = df2, aes(fill='1')) +
  
  geom_vline(xintercept = data_mean, linetype='dotted') +
  annotate(geom = "label", label = data_lab, x = data_mean, y = 20, hjust = 0, fill = "white", alpha = 0.5) +
  
  # Add the proportion of girl babies in general population
  geom_vline(xintercept = pop_freq, linetype='dotted') +
  annotate(geom = "label", label = lab_pop, x = pop_freq, y = 20, hjust = 0, fill = "white",  alpha = 0.5) +
  # Decorate the plot a little
  labs(title='Uniform prior -> Posterior is Beta(438,544)') +
  scale_y_continuous(expand = c(0, 0.1)) +
  scale_fill_manual(values = 'lightblue', labels = '95% posterior interval') +
  theme(legend.position = 'bottom', legend.title = element_blank())

```



### Posterior Analysis

#### Calculation Methods

- **Analytical Approach:** Utilising properties of the beta distribution, the posterior mean is 0.446 and the posterior standard deviation is 0.016.
- **Simulation Approach:** Drawing 1000 samples from the Beta(438, 544) posterior, the sample mean and standard deviation closely match the analytical results.

#### Confidence Intervals

- **Beta Quantiles:** The 95% confidence interval for $\theta$ from beta properties is [0.415, 0.477].
- **Simulation-based Estimate:** Using ordered draws, the 95% interval is similarly [0.415, 0.476].
- **Normal Approximation:** For practical ease, a normal approximation gives [0.414, 0.476], indicating robustness of the estimate.

### Enhanced Precision with Logit Transformation

Transforming $\theta$ to the logit scale:

$$ \text{logit}(\theta) = \log\left(\frac{\theta}{1-\theta}\right) $$

This transformation stabilises variance, especially beneficial for values of $\theta$ near boundaries. The logit-transformed values follow a normal distribution, allowing us to back-calculate the confidence interval for $\theta$ effectively.

## Considerations on Prior Sensitivity

Exploring different **conjugate priors** with varying strengths of belief around the general population proportion (0.485), the results show that large sample sizes dilute the influence of these priors, as seen with the posterior distributions retaining similar confidence intervals across various priors.

## Plotting decision
The choice of the values for the sequence `seq(0.375, 0.525, 0.001)` in `df1`  is designed to provide a detailed and continuous visualization of the posterior probability density function (pdf) of $$\theta$$ (the probability of a girl birth given placenta previa) over a relevant range of $$\theta$$ values.

- **Start (0.375) and End (0.525)**: These values define the range over which the posterior distribution will be evaluated and plotted. The range is chosen to be slightly broader than the central 95% posterior interval calculated from the Beta distribution (Beta(438, 544)), which is [0.415, 0.477]. This broader range allows the plot to display the tails of the distribution, providing a complete view of how the density behaves towards the edges, which is informative for understanding the distribution's shape and spread.
- **Relevance to the Data**: The range centers around the expected posterior mean ($$0.446$$) and includes the entire 95% confidence interval, thereby capturing the most statistically significant values of $$\theta$$ under the given model and data.








## Conclusion

The Bayesian analysis, robust across several approaches, suggests that the probability of a female birth given placenta previa is less than the general population's proportion. The findings are consistent despite different computational methods and prior assumptions, illustrating the power of Bayesian inference in real-world data interpretation.
=======
* $$0.485$$ - the frequency of normal female births in the population
* As in part 1, we had a posterior Beta(438,544)

```{r Bayes_ex2_data, include=TRUE}
a <- 437 # girls
b <- 543 # boys
```

## Exploring the effect of different priors

**Density evaluation**: We calculate the density of the posterior distribution over a range of theta values using a uniform prior for simplicity.

```{r Bayes_ex2_post, include=TRUE}
# Evaluate densities at evenly spaced points between 0.375 and 0.525
df1 <- data.frame(theta = seq(0.375, 0.525, 0.001))

# Posterior with Beta(1,1), ie. uniform prior
df1$pu <- dbeta(df1$theta, a+1, b+1)
```

**Further prior variations**: We set up priors with varying strengths by modifying the prior counts and success ratio, reflecting different degrees of confidence in the prior information.

```{r Bayes_ex2_helper, include=TRUE}
# 3 different choices for priors
# Beta(0.485*2,(1-0.485)*2)
# Beta(0.485*20,(1-0.485)*20)
# Beta(0.485*200,(1-0.485)*200)
n <- c(2, 20, 200) # prior counts
apr <- 0.485 # prior ratio of success
```

- **Beta distribution parameters**: These parameters are set to reflect increasing confidence in prior information, with the product of 0.485 and multipliers (2, 20, 200) determining the strength of the prior belief. This adjustment in parameters influences how much the prior beliefs affect the Bayesian updating process.
- **Prior counts (`n`)**: Specifies the strength of the prior. Lower counts like 2 suggest minimal prior influence, while higher counts like 200 indicate a strong prior belief based on substantial evidence or confidence.
- **Prior probability of success (`apr`)**: Represents an assumed rate of female births, serving as the basis for setting the Beta distribution parameters, thereby impacting the shape of the posterior distribution.

This setup allows for the examination of how prior beliefs, quantified by `n` and `apr`, impact the posterior estimates. By varying these priors, we see the Bayesian framework's sensitivity to initial assumptions, highlighting the need for careful consideration of prior information in Bayesian analysis.

The following helper function and lapply construct compile the dataset as described: helperf computes prior and posterior densities for a range of theta values based on varying strengths of prior beliefs. This is combined using lapply across different prior settings, and the results are consolidated and reshaped for plotting

```{r Bayes_ex2_helper2, include=TRUE}
# helperf returns for given number of prior observations, prior ratio
# of successes, number of observed successes and failures and a data
# frame with values of theta, a new data frame with prior and posterior
# values evaluated at points theta.
helperf <- function(n, apr, a, b, df)
  cbind(df, pr = dbeta(df$theta, n*apr, n*(1-apr)), po = dbeta(df$theta, n*apr + a, n*(1-apr) + b), n = n)

# lapply function over prior counts n and pivot results into key-value pairs.
df2 <- lapply(n, helperf, apr, a, b, df1) %>%
  do.call(rbind, args = .) %>%
  pivot_longer(!c(theta, n), names_to = "density_group", values_to = "p") %>%
  mutate(density_group = factor(density_group, labels=c('Posterior','Prior','Posterior with unif prior')))

# add correct labels for plotting
df2$title <- factor(paste0('alpha/(alpha+beta)=0.485, alpha+beta=',df2$n))
```

```{r Bayes_ex2_dataext, include=FALSE}
pop_freq <- 0.485
lab_pop <- paste0("Population\nfrequency of\nfemale births:\n", pop_freq)
```

```{r Bayes_ex2_plot, include=TRUE}
# Plot distributions
ggplot(data = df2) +
  geom_line(aes(theta, p, color = density_group)) +
	  # proportion of girl babies in general population
  geom_vline(xintercept = pop_freq, linetype='dotted') +
  annotate(geom = "label", label = lab_pop, x = pop_freq, y = 20, hjust = 0, fill = "white",  alpha = 0.5, size =2) +
  facet_wrap(~title, ncol = 1)

```

The resulting plots highlight how the choice of prior affects the posterior, with visual cues like vertical lines at the prior mean and faceting by scenario.

## Conclusion

The exploration in part 2 demonstrates the Bayesian framework's flexibility and the critical role of prior selection. By comparing different priors, we see how prior beliefs can substantially influence posterior outcomes, thereby affecting conclusions drawn from Bayesian analysis.
>>>>>>> 6aec6a2f5ba6be1f95b272c6787227c9cd656bce
